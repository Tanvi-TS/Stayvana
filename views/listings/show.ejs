<% layout('/layouts/boilerplate') %>

<div class="row">
  <div class="col-8 offset-2">

    <div class="card">

      <h3 class="card-title mt-3 mb-3">
        <%= listing.title %>
      </h3>

      <img 
        src="<%= listing.image %>" 
        class="card-img-top show-img mb-3" 
        alt="listing image"
      >

      <div class="card-body mb-3">
        <p class="card-text">
          <%= listing.description %>
        </p>
      </div>

      <ul class="list-group list-group-flush card-body">

        <li class="list-group-item price-tag">
          <strong>Price:</strong> &#8377;<%= listing.price.toLocaleString("en-IN") %> / night
        </li>

        <li class="list-group-item">
          <strong>Location:</strong> <%= listing.location %>
        </li>

        <li class="list-group-item">
          <strong>Country:</strong> <%= listing.country %>
        </li>

      </ul>

      <!-- OWNER CARD -->
      <div class="owner-card mt-4 mb-4">
        <div class="owner-details">
          <h6>Hosted by</h6>
          <p class="owner-name">
            <%= listing.owner.username %>
          </p>
          <p class="owner-email">
            <i class="fa-regular fa-envelope"></i>
            <%= listing.owner.email %>
          </p>
        </div>
      </div>

      <!-- ACTION BUTTONS -->
        <% if(currUser && currUser._id.equals(listing.owner._id)){ %>
        <form method="GET" action="/listings/<%= listing._id %>/edit">
          <button type="submit" class="edit-btn mb-4">
            Edit
          </button>
        </form>

        <form 
          method="POST" 
          action="/listings/<%= listing._id %>?_method=DELETE"
        >
          <button type="submit" class="delete-btn mb-4">
            Delete
          </button>
        </form>
      <% } %>

      <!-- REVIEWS SECTION -->
      <hr>
    <% if(currUser){ %>
      <h4>Leave a review</h4>

      <form 
        action="/listings/<%= listing._id %>/reviews" 
        method="POST" 
        novalidate 
        class="needs-validation"
      >

        <div class="mt-3">
          <label for="rating" class="form-label">
            Rating:
          </label>
          <input 
            id="rating" 
            type="range" 
            min="0" 
            max="5" 
            name="review[rating]"
          >
        </div>

        <div class="mt-3">
          <label for="comment" class="form-label">
            Leave a Comment:
          </label>

          <textarea 
            name="review[comment]" 
            id="comment" 
            placeholder="Share your experience..."
            rows="4" 
            class="form-control"
            required
          ></textarea>

          <div class="invalid-feedback">
            A review needs a comment — please write one.
          </div>
        </div>

        <button 
          type="submit" 
          class="add-new-btn mt-4 mb-3"
        >
          Add review
        </button>

      </form>
      <hr>
      <% } %>

      <h4>Reviews</h4>

      <% if (listing.reviews.length === 0) { %>
        <p class="text-muted">No reviews yet.</p>
      <% } %>

      <% for (let review of listing.reviews) { %>
        <div class="listing-card mb-3">

          <div class="d-flex justify-content-between align-items-center">
            <strong>
              @<%= review.author?.username || "User" %>
            </strong>

            <span class="badge bg-success">
              <%= review.rating %> ★
            </span>
          </div>

          <p class="mt-2 mb-2">
            <%= review.comment %>
          </p>

          <% if(currUser && currUser._id.equals(review.author._id)){ %>
          <form 
            action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
            method="POST"
            class="text-end"
          >
            <button class="btn btn-sm btn-outline-danger">
              Delete
            </button>
          </form>
          <% } %> 
        </div>
      <% } %>
    </div>
  </div>
</div>
